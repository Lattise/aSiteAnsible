# 上线流程

上线分为代码准备、deploy、fire三个阶段。

## 代码准备阶段

此阶段目的在于在代码库中打好tag，用于上线。

* 首先，将要合并的分支rebase master，然后合并（使用`--no-ff`选项）
* 其次，在此分支上打好tag（tag命名遵循[Semantic Versioning](http://semver.org/)，比如`v1.2.3`、`1.2.3`都是合适的tag）

## deploy阶段

此阶段讲代码部署到服务器上，但是当前为用户提供服务的仍然是旧代码。此时可以执行切换前的准备工作，比如执行job等。

部署脚本一般在跳板机的`~/angel`目录，部署用的代码库一般在跳板机的`~/angel/repos/`目录.

* 首先，使用`<proj>.py -D <ver>`脚本将对应的tag部署到服务器上（其中会需要手动选择tag，但是默认是最新的tag，所以一般不用自己输入）
* 如果有migration需要跑，则要在代码目录**拉取最新代码**并在core目录执行migration
* 如果有job需要执行，则需要手工登录job机器，然后进入新代码目录， 以`www-data`用户执行对应的job

## fire阶段

此阶段将服务的代码换为新代码。

* 首先，使用`<proj>.py -F <ver>`脚本将当前工作的代码切换为新代码（其中会需要手动选择tag，但是默认是最新的tag，所以一般不用自己输入）。
* 如果有最后的收尾工作，请不要忘记。
